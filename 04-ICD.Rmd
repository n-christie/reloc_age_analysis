
# ICD codes.

Data files from Socialstyrelsen includes inpatient and outpatient data ranging from 1987 to 2020.
A particular area of interest in these data files is that of the reported International Classification of Diseases (ICD) codes reported by the physicians from  inpatient/outpatient visits.
Closely examining the ICD codes, it is possible to not only classify individuals into groups  according to specific risks (eg. high influenza risk),
but also to observe outcomes(contracts influenza).

This section documents the process of code extraction,
classification, and details in working with the ICD codes reported by Socialstyrelsen. 

## ICD Code types

Working with ICD codes is notoriously messy.
There are a multitude of disease codes (ICD-10CM has around 70,000) which may differ slightly depending on which country uses them (18 different countries had national adoptions).
The classification system has changed over the years, from ICD 8, ICD 9, to the contemporary ICD 10.
ICD 11 is on the horizon.
Translating 

The follow are points that need to be addressed when working with ICD codes:

* ICD codes in the earlier years may need to be converted to ICD 10 for proper classification

* ICD codes may be reported in different formats and need to be standardized(eg. A12.2 may be reported as A122 or A12200)

* Similarly, upper and lower case is often mixed across the data tables(eg. a112.b and A112.B)

* ICD code chapters are often reported in place of an individual ICD code.
These are reported as a code range, such as "H00-H59", but may take on various iterations which make matching challenging (eg. "H00-H590", H000-H590","H00-H599", "H00-H99". etc)

## Decoding the codes - matching

The approach taken to match ICD codes for further classification begins with identifying matches to the ICD code and code-ranges present in the Socialstrylsen data with the corresponding definitions provided by Socialstrylsen.
This step is easier said than done.

With the end aim to classify these diagnosis codes into Risk groups,
this step is essential as much of the Socialstyrelsen data is reported in code ranges(eg. H00-H59),
while the ICD codes found in the risk categories are reported as single codes(eg. H12).



```{r,out.width="100%"}

knitr::include_graphics(here("output/figures", "icd_dups.png"))
```

Here we see patient "X" has had four inpatient hospital visits in 2014.  We can examine the second row and see the following:

* The main diagnosis (hdia) is given as "C15-C26" in this hospital visit, which is the same as Diagnosis 1 (dia1).  This pattern is most commonly seen in the data, where Diagnosis 1 is identical to the Primary diagnosis. 
* Additional diagnoses from the same visit can be seen across the columns dia1 through dia11.  Here we notice duplicates, presumably because there are multiple and unique diagnoses that fall within the reported range of value "C76-C80".


To further investigate the multiple ICD codes from these single visits,
it is helpful to transform the data from wide format to long format,
where each row represent a single ICD code,
to facilitate the joining of descriptions and to classify the codes.


The following table show the data after transforming from wide to long,
calculating the number of days per visit,
and matching a ICD definition to the code (or code range) that is present in the data.
Duplicate ICD codes from the same visit are removed as they contain no further information.
A column documenting which source file the definition originates from is also included to trace specific definitions back to the corresponding Socialstyrelsen document or table.


```{r,out.width="100%"}

knitr::include_graphics(here("output/figures", "icd_pivot.png"))
```


Tables to match primarily originate from Socialstyrelsen found here:

https://www.socialstyrelsen.se/statistik-och-data/klassifikationer-och-koder/icd-10/

